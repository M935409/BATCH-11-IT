<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT BATCH 11 | # MTR # </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap');

        :root {
            --primary: #22d3ee;
            --primary-hover: #0891b2;
            --bg-gradient: radial-gradient(circle at top left, #0f172a, #020617);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(34, 211, 238, 0.3);
            transform: translateY(-5px);
        }

        /* Tabs Animation */
        .tab-content { display: none; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }

        /* Custom Input */
        input, textarea {
            background: rgba(0, 0, 0, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            padding: 14px 18px;
            border-radius: 16px;
            outline: none;
            width: 100%;
            transition: all 0.3s ease;
        }
        input:focus { border-color: var(--primary) !important; box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); }

        /* Fancy Loader */
        .loader {
            width: 20px; height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Image Viewer Backdrop */
        #viewer {
            transition: opacity 0.4s ease;
            background: rgba(0, 0, 0, 0.95);
        }

        /* Confirmation Modal Overlay */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <!-- Notification Toasts -->
    <div id="toast-container" class="fixed top-5 left-5 z-[10000] space-y-3"></div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[9000] hidden items-center justify-center p-4 modal-overlay">
        <div class="glass-panel max-w-sm w-full p-8 rounded-[2rem] text-center space-y-6 scale-95 transition-transform">
            <div id="confirm-icon-box" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto">
                <i id="confirm-icon" data-lucide="help-circle" class="w-8 h-8"></i>
            </div>
            <div>
                <h3 id="confirm-title" class="text-xl font-bold mb-2">هل أنت متأكد؟</h3>
                <p id="confirm-desc" class="text-gray-400 text-sm">لا يمكن التراجع عن هذا الإجراء لاحقاً.</p>
            </div>
            <div class="flex gap-3">
                <button id="confirm-yes" class="flex-1 py-3 rounded-xl font-bold bg-white text-black hover:bg-gray-200 transition-colors">تأكيد</button>
                <button onclick="closeConfirm()" class="flex-1 py-3 rounded-xl font-bold bg-white/10 hover:bg-white/20 transition-colors">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass-panel sticky top-0 z-[5000] px-6 py-4 border-b border-white/5">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="showSection('home')">
                <div class="w-12 h-12 bg-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-cyan-500/30 group-hover:rotate-12 transition-transform">
                    <i data-lucide="layout-grid" class="text-white"></i>
                </div>
                <div>
                    <h1 class="font-black text-xl tracking-tighter leading-none">IT <span class="text-cyan-400">BATCH 11</span></h1>
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">MTR Cloud</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div id="user-nav-info" class="hidden md:flex items-center gap-3 ml-6 border-l border-white/10 pl-6">
                    <div class="text-left">
                        <p class="text-[10px] text-gray-500 font-bold leading-none">مرحباً بك</p>
                        <p id="nav-username" class="text-sm font-black text-cyan-400"></p>
                    </div>
                </div>
                
                <button onclick="showSection('admin-auth')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 transition-all">
                    <i data-lucide="shield-lock" class="w-5 h-5"></i>
                </button>

                <div id="auth-buttons" class="flex items-center gap-2">
                    <button onclick="showSection('login')" class="text-sm font-bold px-5 py-2.5 rounded-xl hover:bg-white/5 transition-all">دخول</button>
                    <button onclick="showSection('register')" class="bg-white text-black text-sm font-bold px-6 py-2.5 rounded-xl hover:bg-cyan-400 transition-all shadow-lg">انضمام</button>
                </div>
                
                <button id="logout-btn" onclick="confirmAction('خروج', 'هل تود تسجيل الخروج من حسابك؟', 'logout', 'log-out', 'blue')" class="hidden bg-red-500/10 text-red-400 p-2.5 rounded-xl hover:bg-red-500/20 transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto w-full p-6">

       <!-- HOME SECTION -->
<section id="home" class="tab-content active py-16 px-4 space-y-16">

    <!-- HERO -->
    <div class="relative overflow-hidden rounded-[3rem] p-10 md:p-16 glass-panel border border-cyan-500/20">

        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-12 text-center md:text-right">

            <!-- TEXT SIDE -->
            <div class="max-w-xl space-y-6">

                <span class="inline-block bg-cyan-500/20 text-cyan-400 px-5 py-2 rounded-full text-[11px] font-black uppercase tracking-widest">
                    جامعة ود مدني للعلوم الطبية و التكنلوجيا
                </span>

                <h2 class="text-5xl md:text-7xl font-black leading-[1.2] tracking-tight">
                    ذكرياتنا
                    <br>
                    <span class="block mt-3 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                        في أمان سحابي
                    </span>
                </h2>

                <p class="text-gray-400 text-lg md:text-xl leading-relaxed">
                    منصة خاصة لطلاب Batch 11 لمشاركة اللحظات المميزة بجودة عالية وأمان تام.
                </p>

            </div>

            <!-- BUTTON SIDE -->
            <div>
                <button onclick="handleUploadClick()"
                    class="group bg-cyan-500 hover:bg-cyan-400 text-black px-14 py-6 rounded-[2rem] font-black text-xl flex items-center gap-4 transition-all duration-300 shadow-[0_0_50px_rgba(34,211,238,0.35)] hover:scale-105">
                    <i data-lucide="plus-circle"
                        class="group-hover:rotate-90 transition-transform duration-300"></i>
                    رفع ذكرى جديدة
                </button>
            </div>

        </div>

        <!-- Abstract Glow -->
        <div class="absolute -top-32 -right-32 w-72 h-72 bg-cyan-500/20 rounded-full blur-[120px]"></div>
        <div class="absolute -bottom-32 -left-32 w-72 h-72 bg-blue-500/10 rounded-full blur-[120px]"></div>

    </div>

    <!-- SECTION DIVIDER -->
    <div class="flex items-center gap-6 px-2">
        <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        <h3 class="font-black text-sm text-gray-500 uppercase tracking-[0.3em]">
            المعرض السحابي
        </h3>
        <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
    </div>

    <!-- GALLERY GRID -->
    <div id="gallery"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10">
        <!-- Gallery items will appear here -->
    </div>

</section>

        <!-- AUTH SECTIONS (LOGIN/REGISTER) -->
        <section id="login" class="tab-content max-w-md mx-auto py-24">
            <div class="glass-panel p-12 rounded-[3rem] space-y-8">
                <div class="text-center space-y-2">
                    <h2 class="text-4xl font-black">عودة حميدة</h2>
                    <p class="text-gray-500 font-bold">سجل دخولك للمتابعة</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="email" id="login-email" placeholder="البريد الإلكتروني" required>
                    <input type="password" id="login-pass" placeholder="كلمة المرور" required>
                    <button type="submit" id="login-btn" class="w-full bg-white text-black py-4 rounded-2xl font-black text-lg hover:bg-cyan-400 transition-all mt-4">دخول</button>
                </form>
                <p class="text-center text-sm font-bold text-gray-500">ليس لديك حساب؟ <a href="#" onclick="showSection('register')" class="text-cyan-400 hover:underline">سجل الآن</a></p>
            </div>
        </section>

        <section id="register" class="tab-content max-w-md mx-auto py-24">
            <div class="glass-panel p-12 rounded-[3rem] space-y-8">
                <div class="text-center space-y-2">
                    <h2 class="text-4xl font-black">انضم إلينا</h2>
                    <p class="text-gray-500 font-bold">كن جزءاً من ذكريات Batch 11</p>
                </div>
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <input type="text" id="reg-name" placeholder="الاسم الكامل" required>
                    <input type="email" id="reg-email" placeholder="البريد الإلكتروني" required>
                    <input type="password" id="reg-pass" placeholder="كلمة المرور (6+ رموز)" required minlength="6">
                    <button type="submit" id="reg-btn" class="w-full bg-cyan-500 text-black py-4 rounded-2xl font-black text-lg hover:bg-cyan-400 transition-all mt-4">إنشاء الحساب</button>
                </form>
            </div>
        </section>

        <!-- ADMIN DASHBOARD -->
        <section id="admin-dash" class="tab-content space-y-10 py-10">
            <div class="flex flex-col md:flex-row justify-between items-end gap-6">
                <div>
                    <h2 class="text-4xl font-black flex items-center gap-4"><i data-lucide="shield-check" class="text-cyan-400"></i> إدارة النظام</h2>
                    <p class="text-gray-500 font-bold mt-1">التحكم في المستخدمين والصلاحيات</p>
                </div>
                <div class="flex gap-4">
                    <div class="glass-card px-6 py-3 rounded-2xl text-center">
                        <p class="text-[10px] text-gray-500 font-black uppercase">إجمالي الأعضاء</p>
                        <p id="total-users" class="text-xl font-black text-cyan-400">--</p>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-[2.5rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="bg-white/5">
                            <tr>
                                <th class="p-6 text-xs font-black text-gray-500 uppercase tracking-widest">المستخدم</th>
                                <th class="p-6 text-xs font-black text-gray-500 uppercase tracking-widest">الإيميل</th>
                                <th class="p-6 text-xs font-black text-gray-500 uppercase tracking-widest">الحالة</th>
                                <th class="p-6 text-center text-xs font-black text-gray-500 uppercase tracking-widest">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="admin-user-table" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ADMIN AUTH -->
        <section id="admin-auth" class="tab-content max-w-md mx-auto py-24 text-center">
            <div class="glass-panel p-12 rounded-[3rem] space-y-8 border-red-500/20">
                <div class="w-20 h-20 bg-red-500/10 text-red-500 rounded-3xl flex items-center justify-center mx-auto">
                    <i data-lucide="lock" class="w-10 h-10"></i>
                </div>
                <h2 class="text-3xl font-black">الوصول للمشرف</h2>
                <form onsubmit="handleAdminLogin(event)" class="space-y-4">
                    <input type="password" id="admin-key" placeholder="كلمة المرور الخاصة" required>
                    <button type="submit" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black hover:bg-red-600 transition-all">فتح النظام</button>
                </form>
            </div>
        </section>

    </main>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 z-[8000] hidden items-center justify-center p-6 modal-overlay">
        <div class="glass-panel max-w-lg w-full p-10 rounded-[3rem] relative animate-in fade-in zoom-in duration-300">
            <button onclick="toggleModal('upload-modal', false)" class="absolute top-8 left-8 w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="text-center mb-10">
                <h3 class="text-3xl font-black mb-2">رفع صورة</h3>
                <p class="text-gray-500 font-bold">شارك لحظاتك مع زملائك</p>
            </div>
            <form onsubmit="handleFileUpload(event)" id="upload-form" class="space-y-6">
                <div class="group border-2 border-dashed border-white/10 rounded-3xl p-12 text-center hover:border-cyan-500/50 hover:bg-cyan-500/5 transition-all cursor-pointer" onclick="document.getElementById('file-input').click()">
                    <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i data-lucide="camera" class="text-cyan-400 w-8 h-8"></i>
                    </div>
                    <p id="file-label" class="text-sm font-black text-gray-400">انقر لاختيار الملف</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*" required onchange="updateFileLabel(this)">
                </div>
                <textarea id="file-caption" placeholder="اكتب وصفاً أو ذكرى عن هذه الصورة..." class="h-32 resize-none"></textarea>
                <button type="submit" id="upload-btn" class="w-full bg-cyan-500 text-black py-5 rounded-[1.5rem] font-black text-lg flex items-center justify-center gap-3 hover:bg-cyan-400 shadow-xl shadow-cyan-500/20">
                    <span id="btn-text">نشر في المعرض</span>
                    <span id="btn-loader" class="loader hidden"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Smart Image Viewer -->
    <div id="viewer" class="fixed inset-0 z-[9999] hidden items-center justify-center p-4 md:p-12 opacity-0" onclick="toggleModal('viewer', false)">
        <div class="relative max-w-5xl w-full h-full flex flex-col items-center justify-center" onclick="event.stopPropagation()">
            <button onclick="toggleModal('viewer', false)" class="absolute top-0 right-0 md:-top-12 md:-right-12 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white transition-all z-10">
                <i data-lucide="x"></i>
            </button>
            <div class="w-full h-full flex items-center justify-center bg-transparent rounded-3xl overflow-hidden">
                <img id="viewer-img" src="" class="max-w-full max-h-full object-contain shadow-2xl rounded-xl">
            </div>
            <div id="viewer-caption-box" class="mt-6 p-6 glass-panel rounded-2xl w-full max-w-2xl text-center">
                <p id="viewer-caption" class="text-lg font-bold text-white"></p>
                <div class="flex justify-center gap-6 mt-3 text-[10px] font-black text-gray-500 uppercase tracking-widest">
                    <span id="viewer-author"></span>
                    <span id="viewer-date"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Supabase Init ---
        const SUPABASE_URL = 'https://tnfxguggaqskizlwwjmr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_8rkweREppgkzZYznMPIJOQ_L1J_FMqg';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let pendingAction = null;

        // --- Core Functions ---
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('is_banned').eq('id', session.user.id).single();
                if (profile?.is_banned) {
                    await supabaseClient.auth.signOut();
                    showToast("عفواً، لقد تم حظرك من النظام", "error");
                    return;
                }
                currentUser = session.user;
                updateUI();
            }
        }

        // --- Modern UI Logic ---
        function showSection(id) {
            const sections = document.querySelectorAll('.tab-content');
            sections.forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active');
            });
            const target = document.getElementById(id);
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 50);
            lucide.createIcons();
        }

        function toggleModal(id, show) {
            const modal = document.getElementById(id);
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => modal.style.opacity = '1', 10);
            } else {
                modal.style.opacity = '0';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 400);
            }
        }

        // --- Confirmation System ---
        function confirmAction(title, desc, actionType, icon = 'help-circle', color = 'cyan', data = null) {
            pendingAction = { type: actionType, data: data };
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-desc').innerText = desc;
            
            const iconBox = document.getElementById('confirm-icon-box');
            const iconEl = document.getElementById('confirm-icon');
            
            iconBox.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto bg-${color}-500/20 text-${color}-500`;
            iconEl.setAttribute('data-lucide', icon);
            
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
            lucide.createIcons();

            document.getElementById('confirm-yes').onclick = async () => {
                await executePendingAction();
                closeConfirm();
            };
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
            pendingAction = null;
        }

        async function executePendingAction() {
            if (!pendingAction) return;
            const { type, data } = pendingAction;

            if (type === 'logout') {
                await logout();
            } else if (type === 'ban') {
                await toggleBan(data.id, data.status);
            } else if (type === 'delete') {
                await deleteUserProfile(data.id);
            }
        }

        // --- Auth handlers ---
        async function handleRegister(e) {
            e.preventDefault();
            const btn = document.getElementById('reg-btn');
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span>`;

            const { data, error } = await supabaseClient.auth.signUp({
                email, password, options: { data: { full_name: name } }
            });

            if (error) {
                showToast(error.message, "error");
                btn.disabled = false;
                btn.innerText = "إنشاء الحساب";
                return;
            }

            await supabaseClient.from('profiles').insert([{ id: data.user.id, full_name: name, email: email, is_banned: false }]);
            
            // Auto Login
            const { data: logData, error: logErr } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (!logErr) {
                currentUser = logData.user;
                updateUI();
                showSection('home');
                showToast("أهلاً بك في العائلة!");
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span>`;

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                showToast("خطأ في البيانات", "error");
                btn.disabled = false;
                btn.innerText = "دخول";
            } else {
                const { data: profile } = await supabaseClient.from('profiles').select('is_banned').eq('id', data.user.id).single();
                if (profile?.is_banned) {
                    await supabaseClient.auth.signOut();
                    showToast("حسابك محظور من الإدارة", "error");
                    btn.disabled = false;
                    btn.innerText = "دخول";
                    return;
                }
                currentUser = data.user;
                updateUI();
                showSection('home');
                showToast("تم تسجيل الدخول بنجاح");
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            updateUI();
            showSection('home');
            showToast("تم تسجيل الخروج");
        }

        // --- Admin Dashboard Logic ---
        function handleAdminLogin(e) {
            e.preventDefault();
            if (document.getElementById('admin-key').value === '123321') {
                renderAdminTable();
                showSection('admin-dash');
            } else {
                showToast("كلمة مرور غير صحيحة", "error");
            }
        }

        async function renderAdminTable() {
            const tbody = document.getElementById('admin-user-table');
            tbody.innerHTML = `<tr><td colspan="4" class="p-20 text-center"><span class="loader"></span></td></tr>`;
            
            const { data, error } = await supabaseClient.from('profiles').select('*');
            if (error) return;

            document.getElementById('total-users').innerText = data.length;

            tbody.innerHTML = data.map(u => `
                <tr class="group hover:bg-white/5 transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-cyan-500/10 text-cyan-400 flex items-center justify-center font-black">
                                ${u.full_name?.charAt(0) || 'U'}
                            </div>
                            <span class="font-bold">${u.full_name || 'بدون اسم'}</span>
                        </div>
                    </td>
                    <td class="p-6 text-gray-500 font-medium">${u.email}</td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${u.is_banned ? 'bg-red-500/10 text-red-500' : 'bg-green-500/10 text-green-500'}">
                            ${u.is_banned ? 'محظور' : 'نشط'}
                        </span>
                    </td>
                    <td class="p-6">
                        <div class="flex justify-center gap-2">
                            <button onclick="confirmAction('تغيير الحالة', 'هل تود تغيير حالة حظر المستخدم؟', 'ban', 'user-x', 'orange', {id:'${u.id}', status:${u.is_banned}})" 
                                    class="w-10 h-10 rounded-xl bg-orange-500/10 text-orange-500 flex items-center justify-center hover:bg-orange-500/20 transition-all">
                                <i data-lucide="shield-alert" class="w-4 h-4"></i>
                            </button>
                            <button onclick="confirmAction('حذف المستخدم', 'سيتم حذف البروفايل نهائياً من النظام.', 'delete', 'trash-2', 'red', {id:'${u.id}'})" 
                                    class="w-10 h-10 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500/20 transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function toggleBan(id, status) {
            await supabaseClient.from('profiles').update({ is_banned: !status }).eq('id', id);
            showToast("تم تحديث الحالة");
            renderAdminTable();
        }

        async function deleteUserProfile(id) {
            await supabaseClient.from('profiles').delete().eq('id', id);
            showToast("تم الحذف");
            renderAdminTable();
        }

        // --- Gallery Logic ---
        async function fetchImages() {
            const { data, error } = await supabaseClient.from('images').select('*').order('created_at', { ascending: false });
            if (error) return;
            
            const container = document.getElementById('gallery');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="col-span-full py-24 text-center opacity-20"><i data-lucide="image" class="w-20 h-20 mx-auto mb-4"></i><p class="font-bold">المعرض فارغ حالياً</p></div>`;
            } else {
                container.innerHTML = data.map(img => `
                    <div class="glass-card rounded-[2.5rem] overflow-hidden flex flex-col group cursor-pointer" onclick="openViewer(${JSON.stringify(img).replace(/"/g, '&quot;')})">
                        <div class="aspect-[4/5] bg-black/40 relative overflow-hidden">
                            <img src="${img.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity p-6 flex items-end">
                                <div class="flex items-center gap-2 text-xs font-black text-cyan-400 uppercase">
                                    <i data-lucide="maximize-2" class="w-4 h-4"></i> تكبير الصورة
                                </div>
                            </div>
                        </div>
                        <div class="p-6 space-y-3">
                            <p class="text-sm font-bold leading-relaxed line-clamp-2">${img.caption || 'بدون وصف'}</p>
                            <div class="flex justify-between items-center pt-4 border-t border-white/5">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-[10px] font-black">
                                        ${img.publisher_name?.charAt(0) || 'U'}
                                    </div>
                                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">${img.publisher_name || 'عضو'}</span>
                                </div>
                                <span class="text-[9px] font-bold text-gray-600">${new Date(img.created_at).toLocaleDateString('ar-EG')}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function openViewer(img) {
            document.getElementById('viewer-img').src = img.url;
            document.getElementById('viewer-caption').innerText = img.caption || 'بدون وصف';
            document.getElementById('viewer-author').innerText = `بواسطة: ${img.publisher_name || 'عضو'}`;
            document.getElementById('viewer-date').innerText = new Date(img.created_at).toLocaleDateString('ar-EG');
            toggleModal('viewer', true);
        }

        function handleUploadClick() {
            if (!currentUser) { 
                showSection('login'); 
                showToast("يجب تسجيل الدخول للرفع", "error"); 
            } else { 
                toggleModal('upload-modal', true); 
            }
        }

        async function handleFileUpload(e) {
            e.preventDefault();
            const file = document.getElementById('file-input').files[0];
            if (!file || !currentUser) return;

            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const uploadBtn = document.getElementById('upload-btn');

            uploadBtn.disabled = true;
            btnText.innerText = "جاري المعالجة...";
            btnLoader.classList.remove('hidden');

            try {
                const fileName = `${Date.now()}_${file.name}`;
                const { data: st, error: stErr } = await supabaseClient.storage.from('images').upload(`public/${fileName}`, file);
                if (stErr) throw stErr;

                const { data: { publicUrl } } = supabaseClient.storage.from('images').getPublicUrl(`public/${fileName}`);

                const { error: dbErr } = await supabaseClient.from('images').insert([{
                    url: publicUrl,
                    caption: document.getElementById('file-caption').value,
                    publisher_id: currentUser.id,
                    publisher_name: currentUser.user_metadata.full_name || currentUser.email
                }]);

                if (dbErr) throw dbErr;

                showToast("تم النشر بنجاح!");
                toggleModal('upload-modal', false);
                fetchImages();
                document.getElementById('upload-form').reset();
                document.getElementById('file-label').innerText = "انقر لاختيار الملف";
            } catch (err) {
                showToast(err.message, "error");
            } finally {
                uploadBtn.disabled = false;
                btnText.innerText = "نشر في المعرض";
                btnLoader.classList.add('hidden');
            }
        }

        // --- Helpers ---
        function updateFileLabel(input) {
            if (input.files && input.files[0]) {
                document.getElementById('file-label').innerText = `تم اختيار: ${input.files[0].name}`;
            }
        }

        function updateUI() {
            const isLogged = !!currentUser;
            document.getElementById('auth-buttons').classList.toggle('hidden', isLogged);
            document.getElementById('logout-btn').classList.toggle('hidden', !isLogged);
            document.getElementById('user-nav-info').classList.toggle('hidden', !isLogged);
            if (isLogged) {
                document.getElementById('nav-username').innerText = currentUser.user_metadata.full_name || currentUser.email;
            }
        }

        function showToast(msg, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `glass-panel px-8 py-4 rounded-2xl text-white font-bold text-sm shadow-2xl border-l-4 transition-all duration-500 transform translate-x-10 opacity-0 ${type === 'success' ? 'border-cyan-500' : 'border-red-500'}`;
            toast.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5 ${type === 'success' ? 'text-cyan-400' : 'text-red-400'}"></i> ${msg}</div>`;
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.remove('translate-x-10', 'opacity-0');
            }, 100);

            setTimeout(() => {
                toast.classList.add('translate-x-10', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        window.onload = () => {
            checkSession();
            fetchImages();
            lucide.createIcons();
        };
    </script>
</body>
</html>
